<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Colon Drone 3000 ‚Äî Full Journey</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    font-family: 'Share Tech Mono', monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
    color: #00ff88;
  }
  #gameWrapper {
    position: relative;
    width: 100vw;
    height: 100vh;
    max-width: 600px;
    max-height: 900px;
  }
  canvas {
    display: block;
    width: 100%;
    height: 100%;
    box-shadow: 0 0 40px rgba(0,200,80,0.1);
  }
  #hud {
    position: absolute;
    top: 0; left: 0; right: 0;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    pointer-events: none;
    z-index: 10;
  }
  .hud-item {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.58rem;
    color: rgba(0,255,136,0.6);
    line-height: 1.6;
    text-shadow: 0 0 8px rgba(0,255,100,0.4);
  }
  .hud-val {
    font-size: 0.9rem;
    color: #00ff88;
    font-weight: 700;
  }
  #sectionBanner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(0.9rem, 3vw, 1.3rem);
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 30px currentColor;
    text-align: center;
    pointer-events: none;
    z-index: 15;
    opacity: 0;
    transition: opacity 0.5s;
    letter-spacing: 0.08em;
  }
  #progressBar {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 4px;
    background: rgba(0,255,136,0.1);
    z-index: 10;
    pointer-events: none;
  }
  #progressFill {
    height: 100%;
    background: linear-gradient(to right, #00aa44, #00ff88);
    transition: width 0.1s;
    box-shadow: 0 0 8px rgba(0,255,136,0.6);
  }
  .screen {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1.5rem;
    background: rgba(0,0,0,0.9);
    z-index: 20;
  }
  .screen.hidden { display: none; }
  .screen-title {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(1.2rem, 4.5vw, 2rem);
    font-weight: 900;
    color: #00ff88;
    text-shadow: 0 0 20px rgba(0,255,136,0.8);
    margin-bottom: 0.3rem;
    letter-spacing: 0.05em;
  }
  .screen-sub {
    font-size: 0.72rem;
    color: rgba(0,255,136,0.5);
    margin-bottom: 1rem;
    line-height: 1.7;
    max-width: 340px;
  }
  .journey-map {
    margin: 0.8rem 0;
    text-align: left;
    font-size: 0.68rem;
    color: rgba(0,255,136,0.6);
    line-height: 2;
    border: 1px solid rgba(0,255,136,0.2);
    padding: 0.7rem 1rem;
    width: 100%;
    max-width: 320px;
  }
  .journey-map span { color: #00ff88; font-weight: bold; }
  .btn {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    color: #000;
    background: #00ff88;
    border: none;
    padding: 0.65rem 1.8rem;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    box-shadow: 0 0 20px rgba(0,255,136,0.4);
    margin-top: 0.8rem;
  }
  .btn:hover { background: #fff; }
  .win-section {
    font-size: 0.7rem;
    color: rgba(0,255,136,0.5);
    margin: 0.3rem 0;
    line-height: 1.8;
  }
  .win-section.done { color: #00ff88; }
  .drone-emoji { font-size: 2.5rem; margin-bottom: 0.8rem; animation: hov 1.5s ease infinite alternate; }
  @keyframes hov { from { transform: translateY(0); } to { transform: translateY(-8px); } }
  #mobileControls {
    position: absolute;
    bottom: 14px;
    left: 0; right: 0;
    display: none;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 15;
    pointer-events: none;
  }
  .ctrl-btn {
    width: 62px; height: 62px;
    background: rgba(0,255,136,0.12);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.3rem;
    cursor: pointer;
    pointer-events: all;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .ctrl-btn:active { background: rgba(0,255,136,0.3); }
  @media (max-width: 768px), (pointer: coarse) { #mobileControls { display: flex; } }

  @media (max-width: 480px) {
    body { justify-content: flex-start; }
    #gameWrapper { max-width: 100vw; max-height: 100vh; }
    .hud-item { font-size: 0.48rem; }
    .hud-val { font-size: 0.75rem; }
    #sectionBanner { font-size: 0.82rem !important; }
    .screen { padding: 1rem; }
    .screen-title { font-size: 1.05rem !important; }
    .screen-sub { font-size: 0.62rem !important; }
    .journey-map { font-size: 0.58rem; padding: 0.5rem 0.7rem; line-height: 1.7; }
    .btn { font-size: 0.68rem; padding: 0.55rem 1.3rem; margin-top: 0.5rem; }
    .win-section { font-size: 0.6rem; }
    .drone-emoji { font-size: 2rem; margin-bottom: 0.5rem; }
    .ctrl-btn { width: 65px; height: 65px; font-size: 1.5rem; }
    #progressBar { height: 5px; }
  }
  @media (max-width: 380px) {
    .journey-map { font-size: 0.54rem; }
    .screen-title { font-size: 0.95rem !important; }
  }

  .scanline {
    position: absolute; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.025) 2px, rgba(0,0,0,0.025) 4px);
    pointer-events: none; z-index: 5;
  }
</style>
</head>
<body>
<div id="gameWrapper">
  <canvas id="c"></canvas>
  <div class="scanline"></div>

  <div id="hud">
    <div class="hud-item">DEPTH<br><span class="hud-val" id="scoreEl">0</span>cm</div>
    <div class="hud-item" style="text-align:center;font-size:0.55rem" id="sectionLabel">‚Äî</div>
    <div class="hud-item" style="text-align:right">LIVES<br><span class="hud-val" id="livesEl">‚ù§‚ù§‚ù§</span></div>
  </div>

  <div id="sectionBanner"></div>
  <div id="progressBar"><div id="progressFill" style="width:0%"></div></div>

  <!-- Intro -->
  <div class="screen" id="introScreen">
    <div class="drone-emoji">üöÅ</div>
    <div class="screen-title">COLON DRONE 3000</div>
    <div class="screen-sub">Navigate your medical drone through all sections of the human colon to reach the ileum!</div>
    <div class="journey-map">
      YOUR JOURNEY:<br>
      <span>‚ë† Rectum</span> ‚Äî 15cm, wide & straight<br>
      <span>‚ë° Sigmoid</span> ‚Äî 40cm, tight S-curves<br>
      <span>‚ë¢ Descending</span> ‚Äî 25cm, narrow, left side<br>
      <span>‚ë£ Transverse</span> ‚Äî 50cm, looser, hangs low<br>
      <span>‚ë§ Ascending</span> ‚Äî 25cm, narrow, right side<br>
      <span>‚ë• Ileum</span> ‚Äî You made it! üéâ
    </div>
    <div class="screen-sub" style="margin-top:0.5rem">‚Üë‚Üì or W S to fly &nbsp;|&nbsp; Touch buttons below</div>
    <button class="btn" onclick="startGame()">BEGIN ENDOSCOPY</button>
  </div>

  <!-- Game Over -->
  <div class="screen hidden" id="gameOverScreen">
    <div style="font-size:2rem;margin-bottom:0.5rem">üí•</div>
    <div class="screen-title">DRONE LOST</div>
    <div class="screen-sub" id="gameOverSection">The colon wins this round.</div>
    <div style="font-family:Orbitron,sans-serif;font-size:2rem;color:#fff;text-shadow:0 0 20px #00ff88;margin:0.5rem 0" id="finalScore">0cm</div>
    <div style="color:rgba(0,255,136,0.4);font-size:0.7rem;margin-bottom:1rem" id="bestScore"></div>
    <button class="btn" onclick="startGame()">TRY AGAIN</button>
  </div>

  <!-- Win -->
  <div class="screen hidden" id="winScreen">
    <div style="font-size:2.5rem;margin-bottom:0.5rem">üéâüöÅüéâ</div>
    <div class="screen-title" style="color:#fff">ILEUM REACHED!</div>
    <div class="screen-sub">Full colonoscopy complete! Outstanding flying.</div>
    <div style="margin:0.5rem 0 1rem;width:100%;max-width:300px">
      <div class="win-section done">‚úì Rectum ‚Äî cleared</div>
      <div class="win-section done">‚úì Sigmoid ‚Äî navigated</div>
      <div class="win-section done">‚úì Descending ‚Äî conquered</div>
      <div class="win-section done">‚úì Transverse ‚Äî traversed</div>
      <div class="win-section done">‚úì Ascending ‚Äî climbed</div>
      <div class="win-section done" style="color:#fff;font-size:0.8rem">üèÜ Ileum ‚Äî REACHED!</div>
    </div>
    <div style="font-family:Orbitron,sans-serif;font-size:1.8rem;color:#fff;text-shadow:0 0 20px #00ff88" id="winScore"></div>
    <button class="btn" onclick="startGame()">PLAY AGAIN</button>
  </div>

  <div id="mobileControls">
    <div class="ctrl-btn" id="upBtn">‚ñ≤</div>
    <div class="ctrl-btn" id="downBtn">‚ñº</div>
  </div>
</div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

function resize() {
  const w = document.getElementById('gameWrapper');
  canvas.width = w.clientWidth;
  canvas.height = w.clientHeight;
}
resize();
window.addEventListener('resize', resize);

// ‚îÄ‚îÄ‚îÄ COLON SECTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Each section has: name, length (frames), color theme, gap behavior, curvature, description
const SECTIONS = [
  {
    name: 'RECTUM',
    label: '‚ë† Rectum',
    desc: 'Wide & straight ‚Äî easy entry',
    lengthFrames: 480,
    cmLength: 15,
    // colors: dark red-pink, smooth walls
    wallColor1: '#2a0808', wallColor2: '#5a1515', edgeColor: 'rgba(220,80,60,0.7)',
    interiorColor: 'rgba(255,100,60,0.04)',
    minGapFrac: 0.52, maxGapFrac: 0.65,
    curvature: 0.04,   // very low ‚Äî almost straight
    speed: 1.8,
    polyps: false,
    haustra: true,     // colon folds
    announcement: '‚ë† RECTUM\nWide & Straight'
  },
  {
    name: 'SIGMOID',
    label: '‚ë° Sigmoid Colon',
    desc: 'Tight S-curves ‚Äî watch out!',
    lengthFrames: 900,
    cmLength: 40,
    wallColor1: '#1f0a0a', wallColor2: '#4d1010', edgeColor: 'rgba(200,60,50,0.75)',
    interiorColor: 'rgba(220,80,50,0.05)',
    minGapFrac: 0.30, maxGapFrac: 0.42,
    curvature: 0.22,   // high ‚Äî tight S bends
    speed: 2.2,
    polyps: true,
    haustra: true,
    announcement: '‚ë° SIGMOID COLON\nTight S-Curves!'
  },
  {
    name: 'DESCENDING',
    label: '‚ë¢ Descending Colon',
    desc: 'Narrow left side ‚Äî stay centered',
    lengthFrames: 600,
    cmLength: 25,
    wallColor1: '#180a05', wallColor2: '#3d1508', edgeColor: 'rgba(180,70,30,0.8)',
    interiorColor: 'rgba(200,90,40,0.05)',
    minGapFrac: 0.28, maxGapFrac: 0.38,
    curvature: 0.10,
    speed: 2.5,
    polyps: true,
    haustra: true,
    announcement: '‚ë¢ DESCENDING\nNarrow & Left'
  },
  {
    name: 'TRANSVERSE',
    label: '‚ë£ Transverse Colon',
    desc: 'Long & loose ‚Äî speed increases',
    lengthFrames: 1100,
    cmLength: 50,
    wallColor1: '#0a0a18', wallColor2: '#1a1a3d', edgeColor: 'rgba(100,80,200,0.65)',
    interiorColor: 'rgba(120,80,220,0.04)',
    minGapFrac: 0.35, maxGapFrac: 0.50,
    curvature: 0.14,
    speed: 2.8,
    polyps: true,
    haustra: true,
    announcement: '‚ë£ TRANSVERSE\nLong Crossing!'
  },
  {
    name: 'ASCENDING',
    label: '‚ë§ Ascending Colon',
    desc: 'Narrow right side ‚Äî almost there!',
    lengthFrames: 600,
    cmLength: 25,
    wallColor1: '#0a1505', wallColor2: '#153008', edgeColor: 'rgba(80,180,60,0.7)',
    interiorColor: 'rgba(80,200,60,0.04)',
    minGapFrac: 0.26, maxGapFrac: 0.36,
    curvature: 0.12,
    speed: 3.2,
    polyps: false,
    haustra: true,
    announcement: '‚ë§ ASCENDING\nAlmost There!'
  },
  {
    name: 'ILEUM',
    label: '‚ë• Ileum ‚Äî FINAL',
    desc: 'You made it!',
    lengthFrames: 200,
    cmLength: 5,
    wallColor1: '#0a0a0a', wallColor2: '#1a2a1a', edgeColor: 'rgba(0,255,136,0.8)',
    interiorColor: 'rgba(0,255,136,0.06)',
    minGapFrac: 0.4, maxGapFrac: 0.5,
    curvature: 0.05,
    speed: 2.0,
    polyps: false,
    haustra: false,
    announcement: '‚ë• ILEUM\nFINAL STRETCH!'
  }
];

const TOTAL_FRAMES = SECTIONS.reduce((a, s) => a + s.lengthFrames, 0);
const SEG_W = 35;

let state = 'intro';
let frame = 0;
let sectionIdx = 0;
let sectionFrame = 0;
let lives = 3;
let best = 0;
let speed = 2;
let segments = [];
let drone = {};
let keys = {};
let touchUp = false, touchDown = false;
let animId;
let bannerTimeout;
let lastSection = -1;
let invincibleFrames = 0;

// Controls
document.addEventListener('keydown', e => { keys[e.key] = true; e.preventDefault(); });
document.addEventListener('keyup', e => { keys[e.key] = false; });

['upBtn','downBtn'].forEach(id => {
  const el = document.getElementById(id);
  const isUp = id === 'upBtn';
  ['touchstart','mousedown'].forEach(ev =>
    el.addEventListener(ev, e => { e.preventDefault(); isUp ? touchUp=true : touchDown=true; }, {passive:false}));
  ['touchend','mouseup','mouseleave'].forEach(ev =>
    el.addEventListener(ev, e => { e.preventDefault(); isUp ? touchUp=false : touchDown=false; }, {passive:false}));
});

function currentSection() { return SECTIONS[sectionIdx]; }

function totalDepthCm() {
  let cm = 0;
  for (let i = 0; i < sectionIdx; i++) cm += SECTIONS[i].cmLength;
  const sec = SECTIONS[sectionIdx];
  cm += (sectionFrame / sec.lengthFrames) * sec.cmLength;
  return Math.round(cm);
}

function startGame() {
  ['introScreen','gameOverScreen','winScreen'].forEach(id =>
    document.getElementById(id).classList.add('hidden'));

  state = 'playing';
  frame = 0;
  sectionIdx = 0;
  sectionFrame = 0;
  lives = 3;
  invincibleFrames = 0;
  lastSection = -1;
  segments = [];

  drone = {
    x: canvas.width * 0.22,
    y: canvas.height / 2,
    vy: 0,
    radius: Math.max(8, canvas.width * 0.022)
  };

  generateInitialSegments();
  if (animId) cancelAnimationFrame(animId);
  loop();
}

function generateInitialSegments() {
  const H = canvas.height;
  const sec = currentSection();
  let centerY = H / 2;
  for (let x = 0; x < canvas.width + SEG_W * 15; x += SEG_W) {
    const gap = H * lerp(sec.minGapFrac, sec.maxGapFrac, Math.random());
    segments.push({ x, centerY, gap, sectionIdx: 0 });
  }
}

function lerp(a, b, t) { return a + (b - a) * t; }

function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

function loop() {
  update();
  draw();
  if (state === 'playing') animId = requestAnimationFrame(loop);
}

function update() {
  frame++;
  sectionFrame++;
  invincibleFrames = Math.max(0, invincibleFrames - 1);

  const sec = currentSection();

  // Check section transition
  if (sectionFrame >= sec.lengthFrames) {
    sectionFrame = 0;
    sectionIdx++;
    if (sectionIdx >= SECTIONS.length) {
      youWin(); return;
    }
    showBanner(SECTIONS[sectionIdx].announcement, SECTIONS[sectionIdx].edgeColor);
  }

  // Show banner on new section
  if (sectionIdx !== lastSection) {
    lastSection = sectionIdx;
    document.getElementById('sectionLabel').textContent = currentSection().label;
    if (sectionIdx > 0) showBanner(currentSection().announcement, currentSection().edgeColor);
    else showBanner(SECTIONS[0].announcement, SECTIONS[0].edgeColor);
  }

  speed = sec.speed + (sectionFrame / sec.lengthFrames) * 0.4;

  // Drone physics
  const gravity = 0.16;
  const thrust = -0.42;

  if (keys['ArrowUp'] || keys['w'] || keys['W'] || touchUp) drone.vy += thrust;
  if (keys['ArrowDown'] || keys['s'] || keys['S'] || touchDown) drone.vy -= thrust;
  drone.vy += gravity;
  drone.vy *= 0.91;
  drone.y += drone.vy;

  // Scroll segments
  segments.forEach(s => s.x -= speed);
  while (segments.length && segments[0].x + SEG_W < 0) segments.shift();

  // Add new segments
  while (!segments.length || segments[segments.length-1].x < canvas.width + SEG_W * 4) {
    const last = segments.length ? segments[segments.length-1] : { x: 0, centerY: canvas.height/2, gap: canvas.height*0.5 };
    const H = canvas.height;
    const s = currentSection();
    const targetGap = H * lerp(s.minGapFrac, s.maxGapFrac, 0.5);
    const newGap = clamp(last.gap + (Math.random()-0.5)*H*0.04, H*s.minGapFrac, H*s.maxGapFrac);
    // Curvature: sinusoidal + random drift
    const drift = (Math.random()-0.5) * H * s.curvature;
    const sineWave = Math.sin(frame * 0.015 * (1 + s.curvature*3)) * H * s.curvature * 0.5;
    const newCY = clamp(last.centerY + drift + sineWave * 0.3, H*0.18, H*0.82);
    segments.push({ x: last.x + SEG_W, centerY: newCY, gap: newGap, sIdx: sectionIdx });
  }

  // Collision
  const H = canvas.height;
  let hit = false;
  if (drone.y - drone.radius < 0 || drone.y + drone.radius > H) hit = true;

  if (!hit) {
    for (const seg of segments) {
      if (drone.x + drone.radius > seg.x && drone.x - drone.radius < seg.x + SEG_W) {
        const top = seg.centerY - seg.gap / 2;
        const bot = seg.centerY + seg.gap / 2;
        if (drone.y - drone.radius < top || drone.y + drone.radius > bot) {
          hit = true; break;
        }
      }
    }
  }

  if (hit && invincibleFrames === 0) {
    lives--;
    invincibleFrames = 90;
    updateHUD();
    if (lives <= 0) { gameOver(); return; }
    drone.vy = 0;
  }

  // Progress
  const totalF = SECTIONS.reduce((a,s)=>a+s.lengthFrames,0);
  let doneF = SECTIONS.slice(0,sectionIdx).reduce((a,s)=>a+s.lengthFrames,0) + sectionFrame;
  document.getElementById('progressFill').style.width = (doneF/totalF*100)+'%';

  updateHUD();
}

function updateHUD() {
  document.getElementById('scoreEl').textContent = totalDepthCm();
  document.getElementById('livesEl').textContent = '‚ù§'.repeat(Math.max(0,lives));
}

function showBanner(text, color) {
  const el = document.getElementById('sectionBanner');
  el.innerHTML = text.replace('\n','<br>');
  el.style.color = color || '#00ff88';
  el.style.textShadow = `0 0 30px ${color||'#00ff88'}`;
  el.style.opacity = '1';
  clearTimeout(bannerTimeout);
  bannerTimeout = setTimeout(() => { el.style.opacity = '0'; }, 2500);
}

function draw() {
  const W = canvas.width, H = canvas.height;
  ctx.fillStyle = '#020404';
  ctx.fillRect(0, 0, W, H);

  drawTunnel(W, H);
  drawDrone(W, H);

  // Vignette
  const vig = ctx.createRadialGradient(W/2,H/2,H*0.2,W/2,H/2,H*0.8);
  vig.addColorStop(0,'transparent');
  vig.addColorStop(1,'rgba(0,0,0,0.55)');
  ctx.fillStyle = vig;
  ctx.fillRect(0,0,W,H);

  // Scan line
  const scanY = (frame*2.5)%H;
  const sg = ctx.createLinearGradient(0,scanY-15,0,scanY+15);
  sg.addColorStop(0,'transparent'); sg.addColorStop(0.5,'rgba(0,255,100,0.03)'); sg.addColorStop(1,'transparent');
  ctx.fillStyle = sg; ctx.fillRect(0,scanY-15,W,30);
}

function drawTunnel(W, H) {
  if (segments.length < 2) return;

  for (let i = 0; i < segments.length - 1; i++) {
    const s = segments[i];
    const n = segments[i+1];
    const sec = SECTIONS[clamp(s.sIdx||sectionIdx, 0, SECTIONS.length-1)];

    const topA = s.centerY - s.gap/2;
    const botA = s.centerY + s.gap/2;
    const topB = n.centerY - n.gap/2;
    const botB = n.centerY + n.gap/2;

    // Top wall
    const tg = ctx.createLinearGradient(0, 0, 0, Math.max(topA,topB));
    tg.addColorStop(0, sec.wallColor1);
    tg.addColorStop(0.5, sec.wallColor2);
    tg.addColorStop(1, lighten(sec.wallColor2, 0.3));
    ctx.fillStyle = tg;
    ctx.beginPath();
    ctx.moveTo(s.x, 0); ctx.lineTo(n.x, 0);
    ctx.lineTo(n.x, topB); ctx.lineTo(s.x, topA);
    ctx.closePath(); ctx.fill();

    // Bottom wall
    const bg2 = ctx.createLinearGradient(0, Math.min(botA,botB), 0, H);
    bg2.addColorStop(0, lighten(sec.wallColor2, 0.3));
    bg2.addColorStop(0.5, sec.wallColor2);
    bg2.addColorStop(1, sec.wallColor1);
    ctx.fillStyle = bg2;
    ctx.beginPath();
    ctx.moveTo(s.x, botA); ctx.lineTo(n.x, botB);
    ctx.lineTo(n.x, H); ctx.lineTo(s.x, H);
    ctx.closePath(); ctx.fill();

    // Edge glow
    ctx.strokeStyle = sec.edgeColor;
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(s.x, topA); ctx.lineTo(n.x, topB); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(s.x, botA); ctx.lineTo(n.x, botB); ctx.stroke();

    // Haustra folds (colon wall texture)
    if (sec.haustra && i % 5 === 0) {
      ctx.strokeStyle = 'rgba(255,255,255,0.04)';
      ctx.lineWidth = 3;
      const mx = (s.x + n.x) / 2;
      ctx.beginPath(); ctx.moveTo(mx, topA + 4); ctx.lineTo(mx, botA - 4); ctx.stroke();
    }

    // Interior glow
    const cx = (s.x + n.x)/2, cy = (s.centerY + n.centerY)/2;
    const rr = Math.min(s.gap, n.gap)*0.38;
    const ig = ctx.createRadialGradient(cx,cy,0,cx,cy,rr);
    ig.addColorStop(0, sec.interiorColor); ig.addColorStop(1, 'transparent');
    ctx.fillStyle = ig;
    ctx.beginPath();
    ctx.moveTo(s.x,topA); ctx.lineTo(n.x,topB); ctx.lineTo(n.x,botB); ctx.lineTo(s.x,botA);
    ctx.closePath(); ctx.fill();
  }

  // Polyps (irregular bumps on wall)
  const sec = currentSection();
  if (sec.polyps) {
    segments.forEach((s, i) => {
      if (i % 9 === 3) {
        const top = s.centerY - s.gap/2;
        ctx.fillStyle = 'rgba(180,60,30,0.5)';
        ctx.beginPath(); ctx.arc(s.x + SEG_W/2, top+7, 6, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'rgba(220,80,40,0.3)';
        ctx.beginPath(); ctx.arc(s.x + SEG_W/2, top+7, 10, 0, Math.PI*2); ctx.fill();
      }
      if (i % 13 === 7) {
        const bot = s.centerY + s.gap/2;
        ctx.fillStyle = 'rgba(180,60,30,0.45)';
        ctx.beginPath(); ctx.arc(s.x + SEG_W/2, bot-8, 8, 0, Math.PI*2); ctx.fill();
      }
    });
  }
}

function lighten(hex, amt) {
  // Simple hex lightener
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  const nr = Math.min(255, r + Math.round(amt*80));
  const ng = Math.min(255, g + Math.round(amt*80));
  const nb = Math.min(255, b + Math.round(amt*80));
  return `rgb(${nr},${ng},${nb})`;
}

function drawDrone(W, H) {
  const x = drone.x, y = drone.y, r = drone.radius, t = frame;
  const blink = invincibleFrames > 0 && Math.floor(invincibleFrames/6)%2===0;
  if (blink) return;

  // Light beam ahead
  const beamGrad = ctx.createLinearGradient(x+r, y, x+r*8, y);
  beamGrad.addColorStop(0,'rgba(255,255,200,0.35)'); beamGrad.addColorStop(1,'transparent');
  ctx.fillStyle = beamGrad;
  ctx.beginPath();
  ctx.moveTo(x+r, y-4); ctx.lineTo(x+r*9, y-14); ctx.lineTo(x+r*9, y+14); ctx.lineTo(x+r, y+4);
  ctx.closePath(); ctx.fill();

  // Outer glow
  const glow = ctx.createRadialGradient(x,y,0,x,y,r*3.5);
  glow.addColorStop(0,'rgba(0,255,136,0.25)'); glow.addColorStop(1,'transparent');
  ctx.fillStyle = glow;
  ctx.beginPath(); ctx.arc(x,y,r*3.5,0,Math.PI*2); ctx.fill();

  // Body
  ctx.fillStyle = '#0a0a0a';
  ctx.strokeStyle = '#00ff88';
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // Rotor arms
  const arms = [[-1,-1],[1,-1],[-1,1],[1,1]];
  arms.forEach(([ax,ay]) => {
    const rx = x + ax*r*1.5, ry = y + ay*r*0.9;
    ctx.strokeStyle = 'rgba(0,255,136,0.5)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(rx,ry); ctx.stroke();

    ctx.save(); ctx.translate(rx,ry); ctx.rotate(t*0.35*ax);
    ctx.strokeStyle = 'rgba(0,255,136,0.65)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.ellipse(0,0,r*0.85,r*0.18,0,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  });

  // Camera lens
  ctx.fillStyle = '#001a0a';
  ctx.strokeStyle = 'rgba(0,255,136,0.5)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.arc(x+r*0.5,y,r*0.35,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // Center dot
  ctx.fillStyle = '#00ff88';
  ctx.beginPath(); ctx.arc(x,y,r*0.25,0,Math.PI*2); ctx.fill();

  // Tilt indicator
  const tilt = clamp(drone.vy * 4, -20, 20);
  ctx.save(); ctx.translate(x,y); ctx.rotate(tilt * Math.PI/180);
  ctx.strokeStyle = 'rgba(0,255,136,0.3)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(-r*1.4,0); ctx.lineTo(r*1.4,0); ctx.stroke();
  ctx.restore();
}

function gameOver() {
  state = 'over';
  const depth = totalDepthCm();
  if (depth > best) best = depth;
  document.getElementById('finalScore').textContent = depth + 'cm';
  document.getElementById('bestScore').textContent = 'BEST: ' + best + 'cm';
  document.getElementById('gameOverSection').textContent =
    'Lost in: ' + currentSection().label + ' ‚Äî ' + currentSection().desc;
  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function youWin() {
  state = 'win';
  document.getElementById('winScore').textContent = totalDepthCm() + 'cm traveled!';
  document.getElementById('winScreen').classList.remove('hidden');
}
</script>
</body>
</html>
